<?php
/**
* @package   s9e\TextFormatter
* @copyright Copyright (c) 2010-2014 The s9e Authors
* @license   http://www.opensource.org/licenses/mit-license.php The MIT License
*/

namespace s9e\TextFormatter\Bundles\Fatdown;

class Renderer extends \s9e\TextFormatter\Renderer
{
	protected $htmlOutput=true;
	protected $params=[];
	protected $xpath;
	public function __sleep()
	{
		$props = get_object_vars($this);
		unset($props['out'], $props['proc'], $props['source'], $props['xpath']);
		return array_keys($props);
	}
	public function renderRichText($xml)
	{
		$dom = $this->loadXML($xml);
		$this->xpath = new \DOMXPath($dom);
		$this->out = '';
		$this->at($dom->documentElement);
		$this->xpath = null;
		return $this->out;
	}
	protected function at(\DOMNode $root)
	{
		if ($root->nodeType === 3)
			$this->out .= htmlspecialchars($root->textContent,0);
		else
			foreach ($root->childNodes as $node)
			{
				$nodeName = $node->nodeName;if($nodeName==='BANDCAMP'){$this->out.='<iframe width="400" height="'.htmlspecialchars(($node->hasAttribute('track_id')||$node->hasAttribute('track_num')?42:120),2).'" allowfullscreen="" frameborder="0" scrolling="no" src="//bandcamp.com/EmbeddedPlayer/';if($node->hasAttribute('album_id')){$this->out.='album='.htmlspecialchars($node->getAttribute('album_id'),2).'/size=';if($node->hasAttribute('track_num'))$this->out.='small/t='.htmlspecialchars($node->getAttribute('track_num'),2);else$this->out.='medium';}else$this->out.='track='.htmlspecialchars($node->getAttribute('track_id'),2).'/size=small';$this->out.='"></iframe>';}elseif($nodeName==='C'){$this->out.='<code>';$this->at($node);$this->out.='</code>';}elseif($nodeName==='CODE'){$this->out.='<pre><code class="'.htmlspecialchars($node->getAttribute('lang'),2).'">';$this->at($node);$this->out.='</code></pre>';}elseif($nodeName==='DAILYMOTION')$this->out.='<iframe width="560" height="315" src="//www.dailymotion.com/embed/video/'.htmlspecialchars($node->getAttribute('id'),2).'" allowfullscreen="" frameborder="0" scrolling="no"></iframe>';elseif($nodeName==='DEL'||$nodeName==='EM'||$nodeName==='H1'||$nodeName==='H2'||$nodeName==='H3'||$nodeName==='H4'||$nodeName==='H5'||$nodeName==='H6'||$nodeName==='LI'||$nodeName==='STRONG'||$nodeName==='SUP'||$nodeName==='html:b'||$nodeName==='html:br'||$nodeName==='html:code'||$nodeName==='html:del'||$nodeName==='html:i'||$nodeName==='html:ins'||$nodeName==='html:rb'||$nodeName==='html:rp'||$nodeName==='html:rt'||$nodeName==='html:rtc'||$nodeName==='html:ruby'||$nodeName==='html:strong'||$nodeName==='html:sub'||$nodeName==='html:sup'||$nodeName==='html:table'||$nodeName==='html:tbody'||$nodeName==='html:tfoot'||$nodeName==='html:thead'||$nodeName==='html:tr'||$nodeName==='html:u'||$nodeName==='p'){$e1=htmlspecialchars(strtr($node->localName,'DEGHILMNOPRSTU','deghilmnoprstu'),3);$v1=preg_match('/^(?:area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|source|track|wbr)$/Di',$e1);$this->out.='<'.$e1.'>';if(!$v1){$this->at($node);$this->out.='</'.$e1.'>';}}elseif($nodeName==='EMAIL'){$this->out.='<a href="mailto:'.htmlspecialchars($node->getAttribute('email'),2).'">';$this->at($node);$this->out.='</a>';}elseif($nodeName==='ESC')$this->out.=htmlspecialchars($this->xpath->evaluate('substring(.,2)',$node),0);elseif($nodeName==='FACEBOOK')$this->out.='<iframe width="560" height="315" src="https://www.facebook.com/video/embed?video_id='.htmlspecialchars($node->getAttribute('id'),2).'" allowfullscreen="" frameborder="0" scrolling="no"></iframe>';elseif($nodeName==='FP'||$nodeName==='HE')$this->out.=htmlspecialchars($node->getAttribute('char'),0);elseif($nodeName==='GROOVESHARK')$this->out.='<object type="application/x-shockwave-flash" typemustmatch="" width="250" height="'.htmlspecialchars(($node->hasAttribute('songid')?40:250),2).'" data="//grooveshark.com/'.htmlspecialchars(($node->hasAttribute('songid')?'songW':'w'),2).'idget.swf"><param name="allowfullscreen" value="true"><param name="flashvars" value="playlistID='.htmlspecialchars($node->getAttribute('playlistid'),2).'&amp;songID='.htmlspecialchars($node->getAttribute('songid'),2).'"><embed type="application/x-shockwave-flash" src="//grooveshark.com/'.htmlspecialchars(($node->hasAttribute('songid')?'songW':'w'),2).'idget.swf" width="250" height="'.htmlspecialchars(($node->hasAttribute('songid')?40:250),2).'" allowfullscreen="" flashvars="playlistID='.htmlspecialchars($node->getAttribute('playlistid'),2).'&amp;songID='.htmlspecialchars($node->getAttribute('songid'),2).'"></object>';elseif($nodeName==='HC')$this->out.='<!--'.htmlspecialchars($node->getAttribute('content'),0).'-->';elseif($nodeName==='HR')$this->out.='<hr>';elseif($nodeName==='IMG'){$this->out.='<img src="'.htmlspecialchars($node->getAttribute('src'),2).'"';if($node->hasAttribute('alt'))$this->out.=' alt="'.htmlspecialchars($node->getAttribute('alt'),2).'"';if($node->hasAttribute('title'))$this->out.=' title="'.htmlspecialchars($node->getAttribute('title'),2).'"';$this->out.='>';}elseif($nodeName==='LIST')if(!$node->hasAttribute('type')){$this->out.='<ul>';$this->at($node);$this->out.='</ul>';}else{$this->out.='<ol>';$this->at($node);$this->out.='</ol>';}elseif($nodeName==='LIVELEAK')$this->out.='<iframe width="640" height="360" src="http://www.liveleak.com/ll_embed?i='.htmlspecialchars($node->getAttribute('id'),2).'" allowfullscreen="" frameborder="0" scrolling="no"></iframe>';elseif($nodeName==='QUOTE'){$this->out.='<blockquote>';$this->at($node);$this->out.='</blockquote>';}elseif($nodeName==='SOUNDCLOUD'){$this->out.='<iframe width="560" height="166" allowfullscreen="" frameborder="0" scrolling="no" src="https://w.soundcloud.com/player/?url=';if($node->hasAttribute('secret_token')&&$node->hasAttribute('playlist_id'))$this->out.='https://api.soundcloud.com/playlists/'.htmlspecialchars($node->getAttribute('playlist_id'),2).'&amp;secret_token='.htmlspecialchars($node->getAttribute('secret_token'),2);elseif($node->hasAttribute('secret_token')&&$node->hasAttribute('track_id'))$this->out.='https://api.soundcloud.com/tracks/'.htmlspecialchars($node->getAttribute('track_id'),2).'&amp;secret_token='.htmlspecialchars($node->getAttribute('secret_token'),2);else{if((strpos($node->getAttribute('id'),'://')===false))$this->out.='https://soundcloud.com/';$this->out.=htmlspecialchars($node->getAttribute('id'),2);if($node->hasAttribute('secret_token'))$this->out.='&amp;secret_token='.htmlspecialchars($node->getAttribute('secret_token'),2);}$this->out.='"></iframe>';}elseif($nodeName==='SPOTIFY'){$this->out.='<iframe width="300" height="'.htmlspecialchars((strpos($node->getAttribute('uri'),':track:')!==false||strpos($node->getAttribute('path'),'track/')===0?80:380),2).'" allowfullscreen="" frameborder="0" scrolling="no" src="https://embed.spotify.com/?uri=';if($node->hasAttribute('uri'))$this->out.=htmlspecialchars($node->getAttribute('uri'),2);else$this->out.='spotify:'.htmlspecialchars(strtr($node->getAttribute('path'),'/',':'),2);$this->out.='"></iframe>';}elseif($nodeName==='TWITCH'){$this->out.='<object type="application/x-shockwave-flash" typemustmatch="" width="620" height="378" data="http://www.twitch.tv/widgets/'.htmlspecialchars(($node->hasAttribute('archive_id')||$node->hasAttribute('chapter_id')?'arch':'l'),2).'ive_embed_player.swf"><param name="allowfullscreen" value="true"><param name="flashvars" value="channel='.htmlspecialchars($node->getAttribute('channel'),2);if($node->hasAttribute('archive_id'))$this->out.='&amp;archive_id='.htmlspecialchars($node->getAttribute('archive_id'),2);if($node->hasAttribute('chapter_id'))$this->out.='&amp;chapter_id='.htmlspecialchars($node->getAttribute('chapter_id'),2);$this->out.='&amp;auto_play=false"><embed type="application/x-shockwave-flash" width="620" height="378" src="http://www.twitch.tv/widgets/'.htmlspecialchars(($node->hasAttribute('archive_id')||$node->hasAttribute('chapter_id')?'arch':'l'),2).'ive_embed_player.swf" allowfullscreen=""></object>';}elseif($nodeName==='URL'){$this->out.='<a href="'.htmlspecialchars($node->getAttribute('url'),2).'"';if($node->hasAttribute('title'))$this->out.=' title="'.htmlspecialchars($node->getAttribute('title'),2).'"';$this->out.='>';$this->at($node);$this->out.='</a>';}elseif($nodeName==='VIMEO')$this->out.='<iframe width="560" height="315" src="//player.vimeo.com/video/'.htmlspecialchars($node->getAttribute('id'),2).'" allowfullscreen="" frameborder="0" scrolling="no"></iframe>';elseif($nodeName==='VINE')$this->out.='<iframe width="480" height="480" src="https://vine.co/v/'.htmlspecialchars($node->getAttribute('id'),2).'/embed/simple" allowfullscreen="" frameborder="0" scrolling="no"></iframe><script async="" src="//platform.vine.co/static/scripts/embed.js" charset="utf-8"></script>';elseif($nodeName==='YOUTUBE'){$this->out.='<iframe width="560" height="315" allowfullscreen="" frameborder="0" scrolling="no" src="//www.youtube.com/embed/'.htmlspecialchars($node->getAttribute('id'),2);if($node->hasAttribute('list')||$node->hasAttribute('t')){$this->out.='?';if($node->hasAttribute('list')){$this->out.='list='.htmlspecialchars($node->getAttribute('list'),2);if($node->hasAttribute('t'))$this->out.='&amp;';}if($node->hasAttribute('t'))$this->out.='start='.htmlspecialchars($node->getAttribute('t'),2);}$this->out.='"></iframe>';}elseif($nodeName==='br')$this->out.='<br>';elseif($nodeName==='e'||$nodeName==='i'||$nodeName==='s');elseif($nodeName==='html:abbr'){$this->out.='<abbr';if($node->hasAttribute('title'))$this->out.=' title="'.htmlspecialchars($node->getAttribute('title'),2).'"';$this->out.='>';$this->at($node);$this->out.='</abbr>';}elseif($nodeName==='html:div'){$this->out.='<div';if($node->hasAttribute('class'))$this->out.=' class="'.htmlspecialchars($node->getAttribute('class'),2).'"';$this->out.='>';$this->at($node);$this->out.='</div>';}elseif($nodeName==='html:span'){$this->out.='<span';if($node->hasAttribute('class'))$this->out.=' class="'.htmlspecialchars($node->getAttribute('class'),2).'"';$this->out.='>';$this->at($node);$this->out.='</span>';}elseif($nodeName==='html:td'){$this->out.='<td';if($node->hasAttribute('colspan'))$this->out.=' colspan="'.htmlspecialchars($node->getAttribute('colspan'),2).'"';if($node->hasAttribute('rowspan'))$this->out.=' rowspan="'.htmlspecialchars($node->getAttribute('rowspan'),2).'"';$this->out.='>';$this->at($node);$this->out.='</td>';}elseif($nodeName==='html:th'){$this->out.='<th';if($node->hasAttribute('colspan'))$this->out.=' colspan="'.htmlspecialchars($node->getAttribute('colspan'),2).'"';if($node->hasAttribute('rowspan'))$this->out.=' rowspan="'.htmlspecialchars($node->getAttribute('rowspan'),2).'"';if($node->hasAttribute('scope'))$this->out.=' scope="'.htmlspecialchars($node->getAttribute('scope'),2).'"';$this->out.='>';$this->at($node);$this->out.='</th>';}else $this->at($node);
			}
	}
}