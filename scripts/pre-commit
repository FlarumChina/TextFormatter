#!/bin/sh
TMP=/dev/shm/phpunit.out
DONE=

for FILEPATH in $(git diff --cached --name-only)
do
	if [[ $FILEPATH != src/* ]] && [[ $FILEPATH != tests/*/* ]];
	then
		continue;
	fi

	MODULE=${FILEPATH#*/}
	MODULE=${MODULE%%/*}

	if [[ `expr match "$DONE" ".* $MODULE"` == 0 ]]
	then
		if [[ -n `git diff --cached -b "src/$MODULE" "tests/$MODULE"` ]]
		then
			DONE="$DONE $MODULE"

			echo "Running PHPUnit on $MODULE"
			phpunit --testdox-text docs/testdox.$MODULE.txt -c tests/phpunit.xml tests/$MODULE | tee $TMP

			if [[ `tail -n2 $TMP` != *OK* ]]
			then
				exit 1;
			fi

			git update-index --add docs/testdox.$MODULE.txt
		fi
	fi
done

exit 0