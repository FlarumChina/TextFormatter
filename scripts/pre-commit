#!/bin/sh
ROOT=$(dirname $(dirname $(realpath $0)))

cd "$ROOT"

if [[ -n `git diff --cached --name-only -b | grep \.md` ]]
then
	./scripts/patchExamples.php
	./scripts/generateTOC.php

	git update-index --add "docs/Cookbook/README.md"
fi

if [[ -n `git diff --cached --name-only -b src/Plugins/MediaEmbed/Configurator/sites.xml` ]]
then
	./scripts/patchExamples.php
	./scripts/patchMediaEmbedReadme.php

	git update-index --add "src/Plugins/MediaEmbed/README.md"
fi

if [[ -n `git diff --cached --name-only -b src/Plugins/BBCodes/Configurator/repository.xml` ]]
then
	./scripts/patchBundledBBCodesCookbook.php

	git update-index --add "src/Plugins/MediaEmbed/README.md"
fi

if [[ -n `git diff --cached --name-only -b src/Plugins/Litedown` ]]
then
	./scripts/patchLitedownSyntax.php

	git update-index --add "src/Plugins/Litedown/Syntax.md"
fi

if [[ -n `git diff --cached --name-only -b "src" "tests" | grep php` ]]
then
	phpunit --exclude-group none --stop-on-failure --testdox-text docs/testdox.txt

	if [ $? -ne 0 ]
	then
		exit 1;
	fi

	git update-index --add "docs/testdox.txt"
fi