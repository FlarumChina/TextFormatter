#!/bin/sh
TMP=/dev/shm/phpunit.out
DONE=

ROOT=`pwd`

for FILEPATH in $(git diff --cached --name-only)
do
	if [[ $FILEPATH != src/* ]] && [[ $FILEPATH != tests/*/* ]];
	then
		continue;
	fi

	MODULE=${FILEPATH#*/}
	MODULE=${MODULE%%/*}

	if [[ `expr match "$DONE" ".* $MODULE"` == 0 ]]
	then
		if [[ -n `git diff --cached -b "$ROOT/src/$MODULE" "$ROOT/tests/$MODULE"` ]]
		then
			DONE="$DONE $MODULE"

			cd "$ROOT/tests/$MODULE"
			echo "Running PHPUnit on $MODULE"
			phpunit --testdox-text "$ROOT/docs/testdox.$MODULE.txt" -c "$ROOT/tests/$MODULE/phpunit.xml" | tee $TMP

			if [[ `tail -n2 $TMP` != *OK* ]]
			then
				exit 1;
			fi

			cd "$ROOT"
			git update-index --add "docs/testdox.$MODULE.txt"
		fi
	fi
done

exit 0