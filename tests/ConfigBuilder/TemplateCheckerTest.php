<?php

namespace s9e\TextFormatter\Tests\ConfigBuilder;

use s9e\TextFormatter\Tests\Test,
    s9e\TextFormatter\ConfigBuilder\Tag,
    s9e\TextFormatter\ConfigBuilder\TemplateChecker;

include_once __DIR__ . '/../../src/autoloader.php';

/**
* @covers s9e\TextFormatter\ConfigBuilder\TemplateChecker
*/
class TemplateCheckerTest extends Test
{
	/**
	* @testdox checkUnsafe() throws an exception on invalid XML
	* @expectedException InvalidArgumentException
	* @expectedExceptionMessage Invalid XML in template: Premature end of data in tag template
	*/
	public function testUnsafeInvalidXML()
	{
		TemplateChecker::checkUnsafe('<x>', new Tag);
	}

	// Start of content generated by ../scripts/patchTemplateCheckerTest.php
	/**
	* @testdox Not safe: <embed src="{@url}"/>
	*/
	public function testCheckUnsafeFFEA6CBF()
	{
		$this->testCheckUnsafe(
			'<embed src="{@url}"/>',
			"The template contains a 'embed' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe: <iframe src="{@url}"/>
	*/
	public function testCheckUnsafeA56D0DBC()
	{
		$this->testCheckUnsafe(
			'<iframe src="{@url}"/>',
			"The template contains a 'iframe' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe: <object src="{@url}"/>
	*/
	public function testCheckUnsafeCA1966B0()
	{
		$this->testCheckUnsafe(
			'<object src="{@url}"/>',
			"The template contains a 'object' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe: <script src="{@url}"/>
	*/
	public function testCheckUnsafeFDDAD6DB()
	{
		$this->testCheckUnsafe(
			'<script src="{@url}"/>',
			"The template contains a 'script' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe if attribute 'id' has filter '#url': <script src="{@url}"/>
	*/
	public function testCheckUnsafeD10CCD19()
	{
		$this->testCheckUnsafe(
			'<script src="{@url}"/>',
			"The template contains a 'script' element with a non-fixed URL",
			array('attributes' => array('id' => array('filterChain' => array('#url'))))
		);
	}

	/**
	* @testdox Safe if attribute 'id' has filter '#number': <script src="https://gist.github.com/{@id}.js"/>
	*/
	public function testCheckUnsafe6C30CE54()
	{
		$this->testCheckUnsafe(
			'<script src="https://gist.github.com/{@id}.js"/>',
			NULL,
			array('attributes' => array('id' => array('filterChain' => array('#number'))))
		);
	}

	/**
	* @testdox Not safe: <SCRIPT src="{@url}"/>
	*/
	public function testCheckUnsafe22C6B53D()
	{
		$this->testCheckUnsafe(
			'<SCRIPT src="{@url}"/>',
			"The template contains a 'SCRIPT' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe: <script SRC="{@url}"/>
	*/
	public function testCheckUnsafe4C83A1C2()
	{
		$this->testCheckUnsafe(
			'<script SRC="{@url}"/>',
			"The template contains a 'script' element with a non-fixed URL"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></script>
	*/
	public function testCheckUnsafe0852D347()
	{
		$this->testCheckUnsafe(
			'<script><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></script>',
			"The template contains a 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:attribute name="SRC"><xsl:value-of select="@url"/></xsl:attribute></script>
	*/
	public function testCheckUnsafe28F6AB47()
	{
		$this->testCheckUnsafe(
			'<script><xsl:attribute name="SRC"><xsl:value-of select="@url"/></xsl:attribute></script>',
			"The template contains a 'script' element with a dynamically generated 'SRC' attribute that does not use a fixed URL"
		);
	}

	/**
	* @testdox Not safe: <script src="http://example.org/legit.js"><xsl:attribute name="src"><xsl:value-of select="@hax"/></xsl:attribute></script>
	*/
	public function testCheckUnsafe2B0FC129()
	{
		$this->testCheckUnsafe(
			'<script src="http://example.org/legit.js"><xsl:attribute name="src"><xsl:value-of select="@hax"/></xsl:attribute></script>',
			"The template contains a 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
		);
	}

	/**
	* @testdox Not safe: <xsl:element name="script"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>
	*/
	public function testCheckUnsafe8127EF08()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="script"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>',
			"The template contains a dynamically generated 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
		);
	}

	/**
	* @testdox Not safe: <xsl:element name="SCRIPT"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>
	*/
	public function testCheckUnsafeC08FCE07()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="SCRIPT"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>',
			"The template contains a dynamically generated 'SCRIPT' element with a dynamically generated 'src' attribute that does not use a fixed URL"
		);
	}

	/**
	* @testdox Not safe: <b disable-output-escaping="1"/>
	*/
	public function testCheckUnsafeCCAC3746()
	{
		$this->testCheckUnsafe(
			'<b disable-output-escaping="1"/>',
			"The template contains a 'disable-output-escaping' attribute"
		);
	}

	/**
	* @testdox Not safe: <xsl:copy/>
	*/
	public function testCheckUnsafe60753852()
	{
		$this->testCheckUnsafe(
			'<xsl:copy/>',
			"Cannot assess the safety of an 'xsl:copy' element"
		);
	}

	/**
	* @testdox Not safe: <b><xsl:copy-of select="@onclick"/></b>
	*/
	public function testCheckUnsafeC19FCB6D()
	{
		$this->testCheckUnsafe(
			'<b><xsl:copy-of select="@onclick"/></b>',
			"Undefined attribute 'onclick'"
		);
	}

	/**
	* @testdox Not safe: <b><xsl:copy-of select=" @ onclick "/></b>
	*/
	public function testCheckUnsafeE26527B5()
	{
		$this->testCheckUnsafe(
			'<b><xsl:copy-of select=" @ onclick "/></b>',
			"Undefined attribute 'onclick'"
		);
	}

	/**
	* @testdox Safe: <b><xsl:copy-of select="@title"/></b>
	*/
	public function testCheckUnsafe990F4294()
	{
		$this->testCheckUnsafe(
			'<b><xsl:copy-of select="@title"/></b>'
		);
	}

	/**
	* @testdox Safe: <b><xsl:copy-of select=" @ title "/></b>
	*/
	public function testCheckUnsafe358E72E5()
	{
		$this->testCheckUnsafe(
			'<b><xsl:copy-of select=" @ title "/></b>'
		);
	}

	/**
	* @testdox Not safe if attribute 'href' has no filter: <a><xsl:copy-of select="@href"/></a>
	*/
	public function testCheckUnsafeE6B9D02C()
	{
		$this->testCheckUnsafe(
			'<a><xsl:copy-of select="@href"/></a>',
			"Attribute 'href' is not properly filtered to be used in URL",
			array('attributes' => array('href' => array()))
		);
	}

	/**
	* @testdox Safe if attribute 'href' has filter '#url': <a><xsl:copy-of select="@href"/></a>
	*/
	public function testCheckUnsafeFE9871D1()
	{
		$this->testCheckUnsafe(
			'<a><xsl:copy-of select="@href"/></a>',
			NULL,
			array('attributes' => array('href' => array('filterChain' => array('#url'))))
		);
	}

	/**
	* @testdox Not safe: <xsl:copy-of select="script"/>
	*/
	public function testCheckUnsafeC8E8CC43()
	{
		$this->testCheckUnsafe(
			'<xsl:copy-of select="script"/>',
			"Cannot assess 'xsl:copy-of' select expression 'script' to be safe"
		);
	}

	/**
	* @testdox Not safe: <xsl:copy-of select=" script "/>
	*/
	public function testCheckUnsafe10D2139E()
	{
		$this->testCheckUnsafe(
			'<xsl:copy-of select=" script "/>',
			"Cannot assess 'xsl:copy-of' select expression 'script' to be safe"
		);
	}

	/**
	* @testdox Not safe: <xsl:copy-of select="parent::*"/>
	*/
	public function testCheckUnsafe1BDDD975()
	{
		$this->testCheckUnsafe(
			'<xsl:copy-of select="parent::*"/>',
			"Cannot assess 'xsl:copy-of' select expression 'parent::*' to be safe"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:apply-templates/></script>
	*/
	public function testCheckUnsafe87044075()
	{
		$this->testCheckUnsafe(
			'<script><xsl:apply-templates/></script>',
			"A 'script' element lets unfiltered data through"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:apply-templates select="st"/></script>
	*/
	public function testCheckUnsafeC968EED0()
	{
		$this->testCheckUnsafe(
			'<script><xsl:apply-templates select="st"/></script>',
			"Cannot assess the safety of 'xsl:apply-templates' select expression 'st'"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:value-of select="st"/></script>
	*/
	public function testCheckUnsafe5D562F28()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="st"/></script>',
			"Cannot assess the safety of XPath expression 'st'"
		);
	}

	/**
	* @testdox Not safe: <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafeAA242A38()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			"Undefined attribute 'foo'"
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafeBD7323B9()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			"Attribute 'foo' is not properly filtered to be used in JS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <xsl:element name="script"><xsl:value-of select="@foo"/></xsl:element>
	*/
	public function testCheckUnsafeD7E78277()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="script"><xsl:value-of select="@foo"/></xsl:element>',
			"Attribute 'foo' is not properly filtered to be used in JS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <xsl:element name="SCRIPT"><xsl:value-of select="@foo"/></xsl:element>
	*/
	public function testCheckUnsafeF7D14089()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="SCRIPT"><xsl:value-of select="@foo"/></xsl:element>',
			"Attribute 'foo' is not properly filtered to be used in JS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has filter 'urlencode': <script><xsl:for-each select="/*"><xsl:value-of select="@foo"/></xsl:for-each></script>
	*/
	public function testCheckUnsafeDD1F8AFC()
	{
		$this->testCheckUnsafe(
			'<script><xsl:for-each select="/*"><xsl:value-of select="@foo"/></xsl:for-each></script>',
			"Cannot evaluate context node due to 'xsl:for-each'",
			array('attributes' => array('foo' => array('filterChain' => array('urlencode'))))
		);
	}

	/**
	* @testdox Not safe: <script><xsl:for-each select="/*"><xsl:apply-templates/></xsl:for-each></script>
	*/
	public function testCheckUnsafe7B26C45D()
	{
		$this->testCheckUnsafe(
			'<script><xsl:for-each select="/*"><xsl:apply-templates/></xsl:for-each></script>',
			"Cannot evaluate context node due to 'xsl:for-each'"
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter 'urlencode': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe3E82294D()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('urlencode'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter 'rawurlencode': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe80E31E96()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('rawurlencode'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#url': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe66FA78F6()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#url'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#int': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafeBEC2826B()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#int'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#uint': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe58430C01()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#uint'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#float': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe196B1007()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#float'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#range': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafeF128A882()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#range'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#number': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe585E44A6()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#number'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#simpletext': <script><xsl:value-of select="@foo"/></script>
	*/
	public function testCheckUnsafe61A72488()
	{
		$this->testCheckUnsafe(
			'<script><xsl:value-of select="@foo"/></script>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#simpletext'))))
		);
	}

	/**
	* @testdox Not safe: <style><xsl:apply-templates/></style>
	*/
	public function testCheckUnsafe9332F4DA()
	{
		$this->testCheckUnsafe(
			'<style><xsl:apply-templates/></style>',
			"A 'style' element lets unfiltered data through"
		);
	}

	/**
	* @testdox Not safe: <style><xsl:apply-templates select="st"/></style>
	*/
	public function testCheckUnsafeE7A11344()
	{
		$this->testCheckUnsafe(
			'<style><xsl:apply-templates select="st"/></style>',
			"Cannot assess the safety of 'xsl:apply-templates' select expression 'st'"
		);
	}

	/**
	* @testdox Not safe: <style><xsl:value-of select="st"/></style>
	*/
	public function testCheckUnsafeF4114812()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="st"/></style>',
			"Cannot assess the safety of XPath expression 'st'"
		);
	}

	/**
	* @testdox Not safe: <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafeFD7FAE5C()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			"Undefined attribute 'foo'"
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe2BEA39BA()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			"Attribute 'foo' is not properly filtered to be used in CSS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <xsl:element name="style"><xsl:value-of select="@foo"/></xsl:element>
	*/
	public function testCheckUnsafeFC0D6B8F()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="style"><xsl:value-of select="@foo"/></xsl:element>',
			"Attribute 'foo' is not properly filtered to be used in CSS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has no filter: <xsl:element name="STYLE"><xsl:value-of select="@foo"/></xsl:element>
	*/
	public function testCheckUnsafe9092B290()
	{
		$this->testCheckUnsafe(
			'<xsl:element name="STYLE"><xsl:value-of select="@foo"/></xsl:element>',
			"Attribute 'foo' is not properly filtered to be used in CSS",
			array('attributes' => array('foo' => array()))
		);
	}

	/**
	* @testdox Not safe if attribute 'foo' has filter '#url': <style><xsl:for-each select="/*"><xsl:value-of select="@foo"/></xsl:for-each></style>
	*/
	public function testCheckUnsafeD5AD8427()
	{
		$this->testCheckUnsafe(
			'<style><xsl:for-each select="/*"><xsl:value-of select="@foo"/></xsl:for-each></style>',
			"Cannot evaluate context node due to 'xsl:for-each'",
			array('attributes' => array('foo' => array('filterChain' => array('#url'))))
		);
	}

	/**
	* @testdox Not safe: <style><xsl:for-each select="/*"><xsl:apply-templates/></xsl:for-each></style>
	*/
	public function testCheckUnsafeB1E49022()
	{
		$this->testCheckUnsafe(
			'<style><xsl:for-each select="/*"><xsl:apply-templates/></xsl:for-each></style>',
			"Cannot evaluate context node due to 'xsl:for-each'"
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#url': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafeA85C9010()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#url'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#int': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe70646A8D()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#int'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#uint': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe11E4EDA4()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#uint'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#float': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafeBF9EE081()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#float'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#color': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe5B459886()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#color'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#range': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe57DD5804()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#range'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#number': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe5C239743()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#number'))))
		);
	}

	/**
	* @testdox Safe if attribute 'foo' has filter '#simpletext': <style><xsl:value-of select="@foo"/></style>
	*/
	public function testCheckUnsafe8D374457()
	{
		$this->testCheckUnsafe(
			'<style><xsl:value-of select="@foo"/></style>',
			NULL,
			array('attributes' => array('foo' => array('filterChain' => array('#simpletext'))))
		);
	}
	// End of content generated by ../scripts/patchTemplateCheckerTest.php

	/**
	* @group dataProvider
	* @dataProvider getUnsafeTemplatesTests
	*/
	public function testCheckUnsafe($template, $exceptionMsg = null, array $tagOptions = array())
	{
		if (isset($exceptionMsg))
		{
			$this->setExpectedException(
				's9e\\TextFormatter\\ConfigBuilder\\UnsafeTemplateException',
				$exceptionMsg
			);
		}

		TemplateChecker::checkUnsafe(
			$template,
			new Tag($tagOptions)
		);
	}

	public function getUnsafeTemplatesTests()
	{
		return array_merge(
			$this->getUnsafeFixedSrcTests(),
			$this->getUnsafeDisableOutputEscapingTests(),
			$this->getUnsafeCopyNodesTests(),
			$this->getUnsafeContentTests()
		);
	}

	public function getUnsafeFixedSrcTests()
	{
		return array(
			array(
				'<embed src="{@url}"/>',
				"The template contains a 'embed' element with a non-fixed URL"
			),
			array(
				'<iframe src="{@url}"/>',
				"The template contains a 'iframe' element with a non-fixed URL"
			),
			array(
				'<object src="{@url}"/>',
				"The template contains a 'object' element with a non-fixed URL"
			),
			array(
				'<script src="{@url}"/>',
				"The template contains a 'script' element with a non-fixed URL"
			),
			// Redundant but produces a nicer entry in testdox
			array(
				'<script src="{@url}"/>',
				"The template contains a 'script' element with a non-fixed URL",
				array(
					'attributes' => array(
						'id' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				'<script src="https://gist.github.com/{@id}.js"/>',
				null,
				array(
					'attributes' => array(
						'id' => array(
							'filterChain' => array('#number')
						)
					)
				)
			),
			// Try working around the safeguards
			array(
				'<SCRIPT src="{@url}"/>',
				"The template contains a 'SCRIPT' element with a non-fixed URL"
			),
			array(
				'<script SRC="{@url}"/>',
				"The template contains a 'script' element with a non-fixed URL"
			),
			array(
				'<script><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></script>',
				"The template contains a 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
			),
			array(
				'<script><xsl:attribute name="SRC"><xsl:value-of select="@url"/></xsl:attribute></script>',
				"The template contains a 'script' element with a dynamically generated 'SRC' attribute that does not use a fixed URL"
			),
			array(
				'<script src="http://example.org/legit.js"><xsl:attribute name="src"><xsl:value-of select="@hax"/></xsl:attribute></script>',
				"The template contains a 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
			),
			array(
				'<xsl:element name="script"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>',
				"The template contains a dynamically generated 'script' element with a dynamically generated 'src' attribute that does not use a fixed URL"
			),
			array(
				'<xsl:element name="SCRIPT"><xsl:attribute name="src"><xsl:value-of select="@url"/></xsl:attribute></xsl:element>',
				"The template contains a dynamically generated 'SCRIPT' element with a dynamically generated 'src' attribute that does not use a fixed URL"
			)
		);
	}

	public function getUnsafeDisableOutputEscapingTests()
	{
		return array(
			array(
				'<b disable-output-escaping="1"/>',
				"The template contains a 'disable-output-escaping' attribute"
			)
		);
	}

	public function getUnsafeCopyNodesTests()
	{
		return array(
			array(
				'<xsl:copy/>',
				"Cannot assess the safety of an 'xsl:copy' element"
			)
		);
	}

	public function getUnsafeContentTests()
	{
		return array_merge(
			$this->getUnsafeCopyOfNodesTests(),
			$this->getUnsafeElementsTests()
		);
	}

	public function getUnsafeCopyOfNodesTests()
	{
		return array(
			array(
				'<b><xsl:copy-of select="@onclick"/></b>',
				"Undefined attribute 'onclick'"
			),
			array(
				'<b><xsl:copy-of select=" @ onclick "/></b>',
				"Undefined attribute 'onclick'"
			),
			array(
				'<b><xsl:copy-of select="@title"/></b>'
			),
			array(
				'<b><xsl:copy-of select=" @ title "/></b>'
			),
			array(
				'<a><xsl:copy-of select="@href"/></a>',
				"Attribute 'href' is not properly filtered to be used in URL",
				array(
					'attributes' => array(
						'href' => array()
					)
				)
			),
			array(
				'<a><xsl:copy-of select="@href"/></a>',
				null,
				array(
					'attributes' => array(
						'href' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				'<xsl:copy-of select="script"/>',
				"Cannot assess 'xsl:copy-of' select expression 'script' to be safe"
			),
			array(
				'<xsl:copy-of select=" script "/>',
				"Cannot assess 'xsl:copy-of' select expression 'script' to be safe"
			),
			array(
				'<xsl:copy-of select="parent::*"/>',
				"Cannot assess 'xsl:copy-of' select expression 'parent::*' to be safe"
			),
		);
	}

	protected function getSafeFilters($type)
	{
		$filters = array(
			'CSS' => array(
				'#url',
				'#int',
				'#uint',
				'#float',
				'#color',
				'#range',
				'#number',
				'#simpletext'
			),
			'JS' => array(
				'urlencode',
				'rawurlencode',
				'#url',
				'#int',
				'#uint',
				'#float',
				'#range',
				'#number',
				'#simpletext'
			),
			'URL' => array(
				'urlencode',
				'rawurlencode',
				'#url',
				'#id',
				'#int',
				'#uint',
				'#float',
				'#range',
				'#number'
			)
		);

		return $filters[$type];
	}

	public function getUnsafeElementsTests()
	{
		$elements = array(
			'script' => 'JS',
			'style'  => 'CSS'
		);

		$tests = array();

		foreach ($elements as $element => $type)
		{
			$filters = $this->getSafeFilters($type);

			$tests[] = array(
				'<' . $element . '><xsl:apply-templates/></' . $element . '>',
				"A '" . $element . "' element lets unfiltered data through"
			);

			$tests[] = array(
				'<' . $element . '><xsl:apply-templates select="st"/></' . $element . '>',
				"Cannot assess the safety of 'xsl:apply-templates' select expression 'st'"
			);

			$tests[] = array(
				'<' . $element . '><xsl:value-of select="st"/></' . $element . '>',
				"Cannot assess the safety of XPath expression 'st'"
			);

			$tests[] = array(
				'<' . $element . '><xsl:value-of select="@foo"/></' . $element . '>',
				"Undefined attribute 'foo'"
			);

			// Try some variations to get around basic checks
			$tagOptions = array(
				'attributes' => array(
					'foo' => array()
				)
			);

			$tests[] = array(
				'<' . $element . '><xsl:value-of select="@foo"/></' . $element . '>',
				"Attribute 'foo' is not properly filtered to be used in " . $type,
				$tagOptions
			);

			$tests[] = array(
				'<xsl:element name="' . $element . '"><xsl:value-of select="@foo"/></xsl:element>',
				"Attribute 'foo' is not properly filtered to be used in " . $type,
				$tagOptions
			);

			$tests[] = array(
				'<xsl:element name="' . strtoupper($element) . '"><xsl:value-of select="@foo"/></xsl:element>',
				"Attribute 'foo' is not properly filtered to be used in " . $type,
				$tagOptions
			);

			// Using xsl:for-each to subvert the context
			$tests[] = array(
				'<' . $element . '><xsl:for-each select="/*"><xsl:value-of select="@foo"/></xsl:for-each></' . $element . '>',
				"Cannot evaluate context node due to 'xsl:for-each'",
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array($filters[0])
						)
					)
				)
			);

			$tests[] = array(
				'<' . $element . '><xsl:for-each select="/*"><xsl:apply-templates/></xsl:for-each></' . $element . '>',
				"Cannot evaluate context node due to 'xsl:for-each'"
			);

			// Test safe filters
			foreach ($filters as $filter)
			{
				$tests[] = array(
					'<' . $element . '><xsl:value-of select="@foo"/></' . $element . '>',
					null,
					array(
						'attributes' => array(
							'foo' => array(
								'filterChain' => array($filter)
							)
						)
					)
				);
			}
		}

		return $tests;
	}
/**
			array(
				'<b style="color:{@foo}"/>',
				"Undefined attribute 'foo'"
			),
			array(
				'<b STYLE="color:{@foo}"/>',
				"Undefined attribute 'foo'"
			),
			array(
				'<b style="color:{@foo}"/>',
				"Attribute 'foo' is not properly filtered to be used in CSS",
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#raw')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#int')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#uint')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#float')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#color')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#range')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#number')
						)
					)
				)
			),
			array(
				'<b style="color:{@foo}"/>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#simpletext')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:apply-templates/></xsl:attribute></b>',
				"A dynamically generated 'style' attribute lets unfiltered data through",
			),
			array(
				'<b style=""><xsl:attribute name="style"><xsl:apply-templates/></xsl:attribute></b>',
				"A dynamically generated 'style' attribute lets unfiltered data through",
			),
			array(
				'<b><xsl:attribute name="STYLE"><xsl:apply-templates/></xsl:attribute></b>',
				"A dynamically generated 'STYLE' attribute lets unfiltered data through",
			),
			array(
				'<b style=""><xsl:attribute name="STYLE"><xsl:apply-templates/></xsl:attribute></b>',
				"A dynamically generated 'STYLE' attribute lets unfiltered data through",
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				"Undefined attribute 'foo'",
			),
			array(
				'<b><xsl:attribute name="STYLE"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				"Undefined attribute 'foo'",
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				"Attribute 'foo' is not properly filtered to be used in CSS",
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#raw')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#int')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#uint')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#float')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#color')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#range')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#number')
						)
					)
				)
			),
			array(
				'<b><xsl:attribute name="style"><xsl:value-of select="@foo"/></xsl:attribute></b>',
				null,
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#simpletext')
						)
					)
				)
			),
			array(
				'<a href="{@foo}"/>',
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected"
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<a HREF="{@foo}"/>'
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of a dynamically generated attribute that expects a valid URL',
				'<a><xsl:attribute name="href"><xsl:value-of select="@foo"/></xsl:attribute></a>'
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of a dynamically generated attribute that expects a valid URL',
				'<a><xsl:attribute name="HREF"><xsl:value-of select="@foo"/></xsl:attribute></a>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<form action="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<q cite="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<object data="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<button formaction="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<html manifest="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<video poster="{@foo}"/>'
			),
			array(
				"The template uses unfiltered or improperly filtered attributes where a valid URL is expected",
				'<img src="{@foo}"/>'
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('urlencode')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('rawurlencode')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#id')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#int')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#uint')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#float')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#range')
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#number')
						)
					)
				)
			),
			array(
				'The template uses unfiltered or improperly filtered attributes where a valid URL is expected',
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#regexp'),
							'regexp'      => '#[0-9]+#'
						)
					)
				)
			),
			array(
				false,
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#regexp'),
							'regexp'      => '#^[0-9]+$#'
						)
					)
				)
			),
			array(
				'The template uses unfiltered or improperly filtered attributes where a valid URL is expected',
				'<a href="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#regexp'),
							'regexp'      => '#^[a-z]+:[a-z]+$#'
						)
					)
				)
			),
			array(
				'The template contains a dynamically generated attribute that expects a valid URL but lets unfiltered data through',
				'<a><xsl:attribute name="href"><xsl:apply-templates/></xsl:attribute></a>'
			),
			array(
				'The template contains a dynamically generated attribute that expects a valid URL but lets unfiltered data through',
				'<a><xsl:attribute name="HREF"><xsl:apply-templates/></xsl:attribute></a>'
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of an HTML event attribute',
				'<b onclick="{@foo}"/>'
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of an HTML event attribute',
				'<b ONCLICK="{@foo}"/>'
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#url')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#int')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#uint')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#float')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#range')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#number')
						)
					)
				)
			),
			array(
				false,
				'<b onclick="{@foo}"/>',
				array(
					'attributes' => array(
						'foo' => array(
							'filterChain' => array('#simpletext')
						)
					)
				)
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of a dynamically created HTML event attribute',
				'<b><xsl:attribute name="onclick"><xsl:value-of select="@foo"/></xsl:attribute></b>'
			),
			array(
				'The template uses unfiltered or improperly filtered attributes inside of a dynamically created HTML event attribute',
				'<b><xsl:attribute name="ONCLICK"><xsl:value-of select="@foo"/></xsl:attribute></b>'
			),
			array(
				'The template contains an HTML event attribute that lets unfiltered data through',
				'<b><xsl:attribute name="onclick"><xsl:apply-templates/></xsl:attribute></b>'
			),
			array(
				'The template contains an HTML event attribute that lets unfiltered data through',
				'<b><xsl:attribute name="ONCLICK"><xsl:apply-templates/></xsl:attribute></b>'
			),
		);
	}
/**/
}